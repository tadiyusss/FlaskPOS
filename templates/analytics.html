{% extends "core_base.html" %}

{% block title %}Analytics{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">
{% endblock %}

{% block content %}
    <h1 class="text-3xl font-semibold mb-5">Analytics</h1>
    <div class="grid grid-cols-4 gap-1">
        <div class="md:col-span-1 col-span-4 border rounded p-3 dark:bg-slate-800 dark:border-slate-700 bg-gray-50 flex justify-between">
            <div>
                <h5 class="text-md font-medium leading-5 dark:text-slate-300">Sales Today</h5>
                <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Our sales for today</p>
                <h5 class="text-2xl font-medium mt-3 dark:text-slate-300">₱{{analytics_data['sales_today']}}</h5>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 text-gray-500 dark:text-slate-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
            </svg>
        </div>

        <div class="md:col-span-1 col-span-4 border rounded p-3 dark:bg-slate-800 dark:border-slate-700 bg-gray-50 flex justify-between">
            <div>
                <h5 class="text-md font-medium leading-5 dark:text-slate-300">Overall Sales</h5>
                <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Total of sales overtime</p>
                <h5 class="text-2xl font-medium mt-3 dark:text-slate-300">₱{{analytics_data['total_sales']}}</h5>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 text-gray-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" />
            </svg>
        </div>

        <div class="md:col-span-1 col-span-4 border rounded p-3 dark:bg-slate-800 dark:border-slate-700 bg-gray-50 flex justify-between">
            <div>
                <h5 class="text-md font-medium leading-5 dark:text-slate-300">Orders Today</h5>
                <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Our orders for today</p>
                <h5 class="text-2xl font-medium mt-3 dark:text-slate-300">{{ analytics_data['orders_today'] }}</h5>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 text-gray-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" />
            </svg>
        </div>

        <div class="md:col-span-1 col-span-4 border rounded p-3 dark:bg-slate-800 dark:border-slate-700 bg-gray-50 flex justify-between">
            <div>
                <h5 class="text-md font-medium leading-5 dark:text-slate-300">Overall Orders</h5>
                <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Total of orders overtime</p>
                <h5 class="text-2xl font-medium mt-3 dark:text-slate-300">{{ analytics_data['total_orders'] }}</h5>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 text-gray-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
            </svg>
        </div>
        
        <div class="md:col-span-2 col-span-4 border rounded bg-gray-50 dark:bg-slate-900 dark:border-slate-700 overflow-auto max-h-96">
            <div class="rounded-t bg-gray-100 p-2 flex justify-between border-b border-gray-200 dark:bg-slate-800 dark:border-slate-700">
                <div>
                    <h5 class="text-md font-medium leading-5 dark:text-slate-300">Sales Table</h5>
                    <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Product sales table</p>
                </div>  
            </div>
            <div>
                {% if analytics_data['sales_table']|length > 0 %}
                <table class="w-full">
                    <thead class="border-b dark:border-slate-700">
                        <tr class="text-left">
                            <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Sale ID</th>
                            <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Quantity</th>
                            <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Total Amount</th>
                            <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Date Created</th>
                            <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Operator Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in analytics_data['sales_table'] %}
                        <tr class="text-slate-300 border-b dark:border-slate-700 hover:bg-gray-100 dark:hover:bg-slate-800">
                            <td class="text-sm p-2 text-gray-800 dark:text-slate-100"><a href="{{ url_for('pos.view_sale_id', sale_id = row['sale_id']) }}" class="underline">{{ row['sale_id'] }}</a></td>
                            <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row['total_quantity'] }}</td>
                            <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ "%.2f"|format(row['total_amount']) }}</td>
                            <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row['created_at'] }}</td>
                            <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row['operator_name'] }}</td>
                        </tr>
                        
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p class="text-center my-5 text-gray-400">No sales date found</p>
                {% endif %}
            </div>
        </div>
        {% if analytics_data['sales_chart']['sales_dates']|length > 0 %}
        <div class="md:col-span-2 col-span-4 border rounded bg-gray-50 dark:bg-slate-900 dark:border-slate-700 h-96 max-h-96">
            <div class="rounded-t bg-gray-100 p-2 flex justify-between border-b border-gray-200 dark:bg-slate-800 dark:border-slate-700">
                <div>
                    <h5 class="text-md font-medium leading-5 dark:text-slate-300">Sales Graph</h5>
                    <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Product sales graph</p>
                </div>
            </div>
            <div class="p-2">
                <canvas id="salesChart1" class="h-72"></canvas>
            </div>
        </div>
        {% endif %}
        <div class="md:col-span-2 col-span-4 border rounded bg-gray-50 dark:bg-slate-900 dark:border-slate-700 h-96 max-h-96">
            <div class="rounded-t bg-gray-100 p-2 flex justify-between border-b border-gray-200 dark:bg-slate-800 dark:border-slate-700">
                <div>
                    <h5 class="text-md font-medium leading-5 dark:text-slate-300">Category</h5>
                    <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Category table</p>
                </div>
            </div>
            {% if category_list|length > 0 %}
            <table class="w-full">
                <thead class="border-b dark:border-slate-700">
                    <tr class="text-left">
                        <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">#</th>
                        <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Name</th>
                        <th class="p-2 font-medium text-gray-600 dark:text-gray-500 text-sm">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in category_list %}
                    <tr class="text-left text-slate-300 border-b dark:border-slate-700 hover:bg-gray-100 dark:hover:bg-slate-800">
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row[0] }}</td>
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row[1] }}</td>
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">
                            <div class="flex">
                                <a href="/dashboard/pos/inventory/edit_category/{{row[0]}}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 stroke-1">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </a>
                                
                                <a href="/api/pos/remove_category/{{row[0]}}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 stroke-1 mx-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                    </svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                    
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="text-center my-5 text-gray-400">No category found</p>
            {% endif %}
        </div>
        <div class="md:col-span-2 col-span-4 border rounded bg-gray-50 dark:bg-slate-900 dark:border-slate-700 max-h-96 overflow-auto">
            <div class="rounded-t bg-gray-100 p-2 flex items-center justify-between border-b border-gray-200 dark:bg-slate-800 dark:border-slate-700">
                <div>
                    <h5 class="text-md font-medium leading-5 dark:text-slate-300">Product</h5>
                    <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Products table</p>
                </div>
            </div>
            {% if product_list|length > 0 %}
            <table class="w-full">
                <thead class="border-b dark:border-slate-700">
                    <tr class="text-left">
                        <th class="p-2 font-medium text-gray-500 text-sm">Name</th>
                        <th class="p-2 font-medium text-gray-500 text-sm">Stocks</th>
                        <th class="p-2 font-medium text-gray-500 text-sm">Price</th>
                        <th class="p-2 font-medium text-gray-500 text-sm">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in product_list %}
                    <tr class="text-left text-slate-300 border-b dark:border-slate-700 hover:bg-gray-100 dark:hover:bg-slate-800">
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row['product_name'] }}</td>
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row['stocks'] }}</td>
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">{{ row['price'] }}</td>
                        <td class="text-sm p-2 text-gray-800 dark:text-slate-100">
                            <div class="flex">
                                <a href="{{ url_for('pos.edit_product', product_id=row['id'])}}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 stroke-1">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </a>
                                
                                <a href="{{ url_for('pos.pos_api.remove_product', product_id = row['id']) }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 stroke-1 mx-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                    </svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="text-center my-5 text-gray-400">No product found</p>
            {% endif %}
        </div>

        <div class="md:col-span-2 col-span-4 border rounded bg-gray-50 dark:bg-slate-900 dark:border-slate-700">
            <div class="rounded-t bg-gray-100 p-2 flex justify-between border-b border-gray-200 dark:bg-slate-800 dark:border-slate-700">
                <div>
                    <h5 class="text-md font-medium leading-5 dark:text-slate-300">Create Category</h5>
                    <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Create category form</p>
                </div>  
            </div>
            <form action="" method="POST" class="p-5">
                {{ category_form.hidden_tag() }}
                <label for="category_name" class="mb-2 text-sm font-medium text-gray-900 dark:text-white">Category Name</label>
                {{ category_form.category_name(class="focus:border-2 mb-2 w-full p-1 dark:bg-slate-800 border dark:border-slate-700 rounded-md focus:outline-none", id="category_name", placeholder="Category 1") }}
                {% with message = get_flashed_messages(with_categories=true) %}
                    {% for category, message in message %}
                        {% if category == "category_success" %}
                            <p class="mb-2 text-green-500">{{ message }}</p>
                        {% elif category == "category_error" %}
                            <p class="mb-2 text-red-500">{{ message }}</p>
                        {% endif %}
                    {% endfor %}
                {% endwith %}
                {{ category_form.submit(class="col-span-2 py-1 px-3 border cursor-pointer ease-in duration-200 bg-gray-100 text-gray-800 hover:bg-gray-200 dark:text-slate-100 dark:bg-slate-800 dark:border-slate-700 dark:hover:text-slate-100 dark:hover:bg-slate-700 rounded") }}
            </form>
        </div>
        <div class="md:col-span-2 col-span-4 border rounded bg-gray-50 dark:bg-slate-900 dark:border-slate-700">
            <div class="rounded-t bg-gray-100 p-2 flex justify-between border-b border-gray-200 dark:bg-slate-800 dark:border-slate-700">
                <div>
                    <h5 class="text-md font-medium leading-5 dark:text-slate-300">Create Product</h5>
                    <p class="text-sm text-gray-500 leading-5 dark:text-slate-500">Create product form</p>
                </div>
            </div>
            <form method="POST" class="p-5" enctype="multipart/form-data"> 
                {{ product_form.hidden_tag() }}
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-3">
                        {{ product_form.product_name.label(class="mb-2 text-sm font-medium text-gray-900 dark:text-white")}}
                        {{ product_form.product_name(placeholder="Product 1", class="focus:border-2 w-full p-1 dark:bg-slate-800 border dark:border-slate-700 rounded-md focus:outline-none")}}
                    </div>
                    
                    <div class="col-span-3">
                        {{ product_form.product_category.label(class="mb-2 text-sm font-medium text-gray-900 dark:text-white") }}
                        {{ product_form.product_category(class="focus:border-2 w-full p-1 dark:bg-slate-800 border dark:border-slate-700 rounded-md focus:outline-none")}}
                    </div>
                    <div class="col-span-3">
                        {{ product_form.product_stocks.label(class="mb-2 text-sm font-medium text-gray-900 dark:text-white") }}
                        {{ product_form.product_stocks(placeholder="0", class="focus:border-2 w-full p-1 dark:bg-slate-800 border dark:border-slate-700 rounded-md focus:outline-none")}}
                    </div>
                    <div class="col-span-3">
                        {{ product_form.product_price.label(class="mb-2 text-sm font-medium text-gray-900 dark:text-white")}}
                        {{ product_form.product_price(placeholder="1.00", class="focus:border-2 w-full p-1 dark:bg-slate-800 border dark:border-slate-700 rounded-md focus:outline-none")}}
                    </div>
                    <div class="col-span-3">
                        {{ product_form.product_visibility.label(class="mb-2 text-sm font-medium text-gray-900 dark:text-white")}}
                        {{ product_form.product_visibility(class="focus:border-2 w-full p-1 dark:bg-slate-800 border dark:border-slate-700 rounded-md focus:outline-none")}}
            
                    </div>        
                    <div class="col-span-3">
                        {{ product_form.product_image}}
                    </div>
                </div>
                {% with message = get_flashed_messages(with_categories=true) %}
                    {% for category, message in message %}
                        {% if category == "product_form_success" %}
                            <p class="mt-3 text-green-600">{{ message }}</p>
                        {% elif category == "product_form_error" %}
                            <p class="mt-3 text-red-500">{{ message }}</p>
                        {% endif %}
                    {% endfor %}
                {% endwith %}
                {{ product_form.submit(class="mt-3 py-1 px-3 border cursor-pointer ease-in duration-200 bg-gray-100 text-gray-800 hover:bg-gray-200 dark:text-slate-100 dark:bg-slate-800 dark:border-slate-700 dark:hover:text-slate-100 dark:hover:bg-slate-700 rounded")}}
        
            </form>
        
        </div>
    </div>
{% endblock %}
{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if analytics_data['sales_chart']['sales_dates']|length > 0 %}
    var ctx = $('#salesChart1')[0].getContext('2d');
    var myLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {% autoescape false %}{{ analytics_data['sales_chart']['sales_dates']}}{% endautoescape %},
            datasets: [{
                label: 'Sales',
                data: {{ analytics_data['sales_chart']['sales_values'] }},
                borderColor: 'rgba(66, 108, 207, 1)',
                backgroundColor: 'rgba(66, 108, 207, 0.2)',
                fill: true,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        display: false
                    }
                }
            }
        }
    });
    {% endif %}

</script>
{% endblock %}